# Tolstoy SDK Automation Setup Guide

## Overview
This guide will help you set up automatic SDK generation for the Tolstoy API using Stainless. Once configured, SDKs will automatically update whenever the OpenAPI specification changes.

## Prerequisites
- ✅ Stainless account and CLI authentication
- ✅ OpenAPI spec at `docs/openapi.json`
- ✅ Stainless config at `stainless.yml`
- ✅ GitHub repository with admin access

## Setup Steps

### 1. Get Your Stainless API Key
1. Go to the [Stainless Dashboard](https://app.stainless.com)
2. Navigate to your organization settings
3. Generate an API key for GitHub Actions
4. Copy the API key (keep it secure)

### 2. Repository Secret (Already Configured ✅)
The required secret is already set up:
- **Name**: `STAINLESS_TOKEN` 
- **Source**: AWS environment (`tolstoy/env`)
- **Status**: ✅ Ready to use

*No additional configuration needed for secrets.*

### 3. Verify Configuration Files
The following files have been created/configured:

#### `.github/workflows/stainless.yml`
- ✅ Automated build previews on PRs
- ✅ Production builds on merge
- ✅ Direct push builds

#### `stainless-workspace.json`
- ✅ Project: `tolstoy-api`
- ✅ OpenAPI spec: `docs/openapi.json`
- ✅ Config: `stainless.yml`
- ✅ TypeScript and Python targets

#### Environment Variables
- ✅ `STAINLESS_ORG`: `pullse-inc`
- ✅ `STAINLESS_PROJECT`: `tolstoy-api`
- ✅ `OAS_PATH`: `docs/openapi.json`

## How It Works

### 🔍 Preview Builds (PR Comments)
When you create a PR that modifies:
- `docs/openapi.json`
- `stainless.yml`

Stainless will:
1. Generate preview SDKs
2. Add a comment to your PR with:
   - Build status and diagnostics
   - Links to preview SDKs
   - Installation instructions for testing

### 🚀 Production Builds (Auto-deploy)
When a PR is merged to main or changes are pushed directly:
1. Stainless generates production SDKs
2. SDKs are pushed to staging repositories
3. Production repositories are updated (if configured)

### 📦 SDK Distribution
Generated SDKs are available at:
- **TypeScript**: `@tolstoy/api` (npm)
- **Python**: `tolstoy-api` (PyPI)
- **GitHub**: Stainless staging repositories

## Testing the Setup

### 1. Test Preview Build
1. Make a small change to `docs/openapi.json` (add a description to an endpoint)
2. Create a PR
3. Wait for Stainless to comment on the PR with build results
4. Verify the comment includes TypeScript SDK preview

### 2. Test Production Build
1. Merge the test PR
2. Check the Actions tab for successful workflow run
3. Verify SDKs are updated in their respective repositories

## Advanced Configuration

### Custom SDK Publishing
To publish SDKs to your own npm/PyPI accounts:

1. Update `stainless.yml`:
```yaml
targets:
  typescript:
    package_name: @your-org/tolstoy-sdk
    production_repo: your-org/tolstoy-typescript
    publish:
      npm: true
```

2. Configure publishing credentials in Stainless dashboard

### Adding More Languages
Update `stainless.yml` to add Go, Java, etc.:
```yaml
targets:
  typescript:
    package_name: tolstoy-api
  python:
    package_name: tolstoy_api
  go:
    package_name: github.com/your-org/tolstoy-go
```

### Custom Build Triggers
Monitor additional files by updating the workflow:
```yaml
on:
  pull_request:
    paths:
      - 'docs/openapi.json'
      - 'stainless.yml'
      - 'src/**/*.controller.ts'  # Trigger on controller changes
```

## Troubleshooting

### ❌ Build Failures
**Symptoms**: PR comment shows build errors
**Solutions**:
- Check OpenAPI spec is valid JSON
- Verify all endpoints have proper decorators
- Review Stainless diagnostics in PR comment

### ❌ No PR Comments
**Symptoms**: No Stainless comment on PR
**Solutions**:
- Verify `STAINLESS_TOKEN` secret is accessible
- Check PR modifies monitored files
- Ensure workflow has correct permissions

### ❌ Permission Errors
**Symptoms**: Workflow fails with permission denied
**Solutions**:
- Verify repository permissions for GitHub Action
- Check `pull-requests: write` permission in workflow
- Ensure API key has correct Stainless permissions

### ❌ Missing SDKs
**Symptoms**: Built SDKs not appearing
**Solutions**:
- Check Stainless dashboard for build status
- Verify production repository configuration
- Review publishing settings in Stainless config

## Monitoring and Maintenance

### Regular Checks
- Monitor PR comments for build diagnostics
- Review Stainless dashboard for build history
- Update API key before expiration

### Best Practices
- Always test breaking changes with preview builds
- Keep OpenAPI spec and decorators up to date
- Review SDK documentation generated by Stainless
- Coordinate with SDK users before major changes

## Support
- 📚 [Stainless Documentation](https://docs.stainless.com)
- 🔧 [GitHub Actions Documentation](https://docs.github.com/en/actions)
- 🎯 Team: Contact @tolstoy-dev for questions

## Next Steps
1. ✅ `STAINLESS_TOKEN` secret is already configured
2. 🎯 Test with a small PR (modify OpenAPI spec)
3. ⚙️ Configure production publishing if needed
4. 📢 Share setup with your team
5. 📝 Document API changes workflow for developers