name: Tolstoy CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" | base64 -d > ssh_key.pem
          chmod 600 ssh_key.pem
          
      - name: âœ… Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -i ssh_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'"
          
      - name: ðŸš€ Deploy application to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ssh_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            
            echo "ðŸ”„ Navigating to application directory..."
            cd ${{ secrets.EC2_PATH }}
            
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git pull origin main
            
            echo "ðŸ“¦ Installing dependencies..."
            yarn install --production=false
            
            echo "âš™ï¸ Generating Prisma client..."
            yarn db:generate
            
            echo "ðŸ”¨ Building application..."
            yarn build
            
            echo "ðŸ”„ Restarting PM2 application..."
            pm2 restart tolstoy-api || pm2 start ecosystem.config.js
            
            echo "ðŸ“Š PM2 status..."
            pm2 status
            
            echo "âœ… Deployment completed successfully!"
          DEPLOY_SCRIPT
          
      - name: ðŸ—ƒï¸ Run database migrations (optional)
        run: |
          ssh -o StrictHostKeyChecking=no -i ssh_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'MIGRATION_SCRIPT'
            set -e
            cd ${{ secrets.EC2_PATH }}
            
            echo "ðŸ—ƒï¸ Running Prisma migrations..."
            yarn db:migrate:deploy || echo "âš ï¸ No migrations to deploy or migration failed"
            
            echo "âœ… Migration step completed!"
          MIGRATION_SCRIPT
          
      - name: ðŸ” Verify deployment
        run: |
          echo "ðŸ” Verifying application health..."
          
          # Wait a moment for the application to start
          sleep 10
          
          # Test health endpoint
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/health)
          
          if [ "$HEALTH_CHECK" -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $HEALTH_CHECK)"
          else
            echo "âŒ Health check failed (HTTP $HEALTH_CHECK)"
            exit 1
          fi
          
          # Test status endpoint
          STATUS_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/status)
          
          if [ "$STATUS_CHECK" -eq 200 ]; then
            echo "âœ… Status check passed (HTTP $STATUS_CHECK)"
          else
            echo "âŒ Status check failed (HTTP $STATUS_CHECK)"
            exit 1
          fi
          
          echo "ðŸŽ‰ Deployment verification successful!"
          
      - name: ðŸ§¹ Cleanup SSH key
        if: always()
        run: |
          rm -f ssh_key.pem
          echo "ðŸ§¹ SSH key cleaned up"
          
      - name: ðŸ“¢ Deployment summary
        if: success()
        run: |
          echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
          echo "ðŸ“Š Summary:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: ${{ github.ref_name }}"
          echo "  â€¢ Commit: ${{ github.sha }}"
          echo "  â€¢ Target: ${{ secrets.EC2_HOST }}"
          echo "  â€¢ Health: http://${{ secrets.EC2_HOST }}/health"
          echo "  â€¢ Status: http://${{ secrets.EC2_HOST }}/status"