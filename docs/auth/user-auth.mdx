---
title: "User-Level OAuth Authentication"
description: "Complete guide to implementing user-level OAuth2 authentication flows for tool integrations"
---

# User-Level OAuth Authentication

User-level OAuth authentication allows individual users to authorize Tolstoy to act on their behalf with various tools and services. This enables personalized integrations where actions are performed with the user's own credentials and permissions.

## Overview

The user-level OAuth flow consists of two main steps:

1. **Login Initiation**: Redirect the user to the OAuth provider's authorization page
2. **Callback Handling**: Process the authorization code and exchange it for access tokens

## Prerequisites

Before implementing user OAuth flows, ensure you have:

- [Organization-level OAuth configuration](/auth/org-auth) set up for the target tool
- Valid OAuth2 credentials (Client ID and Client Secret) from the provider
- Properly configured redirect URI in your OAuth application settings

## OAuth Flow Steps

### Step 1: Configure Organization OAuth Settings

First, configure the OAuth2 settings for your organization using the Tool Authentication API:

<CodeGroup>
```bash cURL
curl -X POST "https://api.tolstoy.dev/tools/tool-123/auth" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "X-Org-ID: your-org-id" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "oauth2",
    "config": {
      "clientId": "your-github-client-id",
      "clientSecret": "your-github-client-secret", 
      "redirectUri": "https://your-app.com/auth/callback",
      "scope": "repo read:user"
    }
  }'
```

```javascript JavaScript SDK
const tolstoy = new TolstoyClient({ apiKey: 'your-api-key' });

await tolstoy.auth.configureOAuth('tool-123', {
  type: 'oauth2',
  config: {
    clientId: 'your-github-client-id',
    clientSecret: 'your-github-client-secret',
    redirectUri: 'https://your-app.com/auth/callback',
    scope: 'repo read:user'
  }
}, {
  orgId: 'your-org-id'
});
```

```python Python
import tolstoy

client = tolstoy.Client(api_key="your-api-key")

client.auth.configure_oauth("tool-123", {
    "type": "oauth2",
    "config": {
        "clientId": "your-github-client-id",
        "clientSecret": "your-github-client-secret",
        "redirectUri": "https://your-app.com/auth/callback",
        "scope": "repo read:user"
    }
}, org_id="your-org-id")
```
</CodeGroup>

### Step 2: Initiate User OAuth Login

To start the OAuth flow for a user, redirect them to the login endpoint:

<APIPlayground>

**GET** `/auth/{toolId}/login`

**Parameters:**
- `toolId` (path): Tool ID for OAuth authentication
- `userId` (query): User ID to associate with the OAuth tokens

**Headers:**
- `X-Org-ID`: Your organization ID

**Response:**
- `302 Redirect`: Redirects user to OAuth provider

</APIPlayground>

<CodeGroup>
```bash cURL
curl -X GET "https://api.tolstoy.dev/auth/tool-123/login?userId=user123" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "X-Org-ID: your-org-id"
```

```javascript JavaScript (Frontend)
// In your frontend application
const initiateOAuth = (toolId, userId) => {
  const url = `https://api.tolstoy.dev/auth/${toolId}/login?userId=${userId}`;
  // Open in popup or redirect current window
  window.open(url, 'oauth-popup', 'width=500,height=600');
};

// Usage
initiateOAuth('tool-123', 'user123');
```

```javascript JavaScript SDK
const tolstoy = new TolstoyClient({ apiKey: 'your-api-key' });

// Get the login URL instead of automatic redirect
const loginUrl = tolstoy.auth.getLoginUrl('tool-123', 'user123');
console.log('Redirect user to:', loginUrl);
```
</CodeGroup>

### Step 3: Handle OAuth Callback

The OAuth provider will redirect the user back to your configured redirect URI. Tolstoy automatically handles this callback:

<APIPlayground>

**GET** `/auth/callback`

**Parameters:**
- `code` (query): Authorization code from OAuth provider
- `state` (query): State parameter for request validation
- `error` (query, optional): Error code if authorization failed

**Response:**
- `200 OK`: User-friendly HTML page indicating success
- `400/500 Error`: User-friendly HTML page with error details

</APIPlayground>

The callback endpoint will:

1. **Validate State**: Ensures the request originated from Tolstoy
2. **Exchange Code**: Trades the authorization code for access tokens
3. **Store Credentials**: Saves user credentials securely in the database
4. **Sync to Secrets**: Optionally backs up tokens to AWS Secrets Manager
5. **Display Result**: Shows a user-friendly success or error page

## Supported OAuth Providers

Tolstoy includes default configurations for popular OAuth providers:

| Provider | Tool Name | Default Scopes | Notes |
|----------|-----------|----------------|-------|
| GitHub | `GitHub` | `read:user` | Supports organization and repository access |
| Google | `Google` | `openid email profile` | Works with Google Workspace and Gmail |
| Microsoft | `Microsoft` | `openid email profile` | Supports Office 365 and Azure AD |
| Slack | `Slack` | `channels:read` | Team and workspace integrations |
| Discord | `Discord` | `identify` | Server and user integrations |
| LinkedIn | `LinkedIn` | `r_liteprofile` | Professional network access |

### Custom OAuth Providers

For custom or unlisted providers, specify the full OAuth URLs in your configuration:

```json
{
  "type": "oauth2",
  "config": {
    "clientId": "your-client-id",
    "clientSecret": "your-client-secret",
    "redirectUri": "https://your-app.com/callback",
    "authorizeUrl": "https://custom-provider.com/oauth/authorize",
    "tokenUrl": "https://custom-provider.com/oauth/token",
    "scope": "read write"
  }
}
```

## Security Features

### State Parameter Validation

Tolstoy uses cryptographically secure state parameters to prevent CSRF attacks:

- **Generation**: Uses `randomUUID()` for cryptographic randomness
- **Storage**: Temporarily stored in Redis with 5-minute expiration
- **Validation**: Checked during callback to ensure request authenticity

### Token Security

User OAuth tokens are protected with multiple layers of security:

- **Database Encryption**: Stored encrypted in PostgreSQL
- **AWS Secrets Backup**: Optionally synced to AWS Secrets Manager
- **Automatic Refresh**: Tokens refreshed automatically when expired
- **Scope Limitation**: Only requested scopes are granted

### Error Handling

The OAuth flow includes comprehensive error handling:

- **Provider Errors**: Access denied, invalid scope, etc.
- **State Validation**: Invalid or expired state parameters
- **Token Exchange**: Network failures, invalid codes
- **User-Friendly Display**: HTML error pages with clear explanations

## Monitoring and Metrics

OAuth flows are monitored with Prometheus metrics:

### Redirect Metrics
```
oauth_redirects_total{toolKey="GitHub"} 150
oauth_redirects_total{toolKey="GitHub",error="true"} 5
```

### Callback Metrics  
```
oauth_callbacks_total{toolKey="GitHub",success="true"} 140
oauth_callbacks_total{toolKey="GitHub",success="false",error="access_denied"} 8
oauth_callbacks_total{toolKey="GitHub",success="false",error="processing_error"} 2
```

## Best Practices

### Frontend Implementation

**Use Popup Windows**: Open OAuth in a popup to maintain user context:

```javascript
const popup = window.open(
  oauthUrl, 
  'oauth-popup', 
  'width=500,height=600,scrollbars=yes'
);

// Listen for popup close
const checkClosed = setInterval(() => {
  if (popup.closed) {
    clearInterval(checkClosed);
    // Refresh user credentials or redirect to success page
    window.location.reload();
  }
}, 1000);
```

**Handle Errors Gracefully**: Check for OAuth errors in your application:

```javascript
// Check if user has valid OAuth tokens
const hasValidToken = await tolstoy.auth.validateToken('tool-123', userId);
if (!hasValidToken) {
  // Prompt user to re-authorize
  initiateOAuth('tool-123', userId);
}
```

### Backend Implementation

**Token Refresh**: Implement automatic token refresh for long-running processes:

```javascript
const getValidToken = async (toolId, userId) => {
  const credentials = await tolstoy.auth.getUserCredentials(toolId, userId);
  
  if (credentials.expiresAt < new Date()) {
    // Token expired, initiate refresh
    await tolstoy.auth.refreshToken(toolId, userId);
    return await tolstoy.auth.getUserCredentials(toolId, userId);
  }
  
  return credentials;
};
```

**Error Recovery**: Handle OAuth failures in your workflows:

```javascript
try {
  const result = await makeAPICall(token);
  return result;
} catch (error) {
  if (error.status === 401) {
    // Token invalid, prompt re-authorization
    throw new Error('User needs to re-authorize');
  }
  throw error;
}
```

## Troubleshooting

### Common Issues

**Redirect URI Mismatch**
- Ensure the `redirectUri` in your configuration exactly matches the URI registered with the OAuth provider
- Include the protocol (`https://`) and avoid trailing slashes

**Invalid Client Credentials** 
- Verify `clientId` and `clientSecret` are correct and active
- Check that the OAuth application is approved/published with the provider

**Scope Issues**
- Ensure requested scopes are available and approved for your OAuth application
- Some providers require additional approval for sensitive scopes

**State Parameter Errors**
- Check that Redis cache is properly configured and accessible
- Verify system clock synchronization across your infrastructure

### Debug Information

Enable debug logging to troubleshoot OAuth flows:

```bash
# Set log level to debug in your environment
LOG_LEVEL=debug npm start
```

Check OAuth metrics in Prometheus:
```bash
curl http://your-api:3000/metrics | grep oauth_
```

## Migration Guide

### From Org-Level to User-Level Auth

If you're migrating from organization-level authentication:

1. **Keep Org Config**: Maintain existing tool auth configurations  
2. **Add User Flow**: Implement user OAuth endpoints in your frontend
3. **Update API Calls**: Pass user context instead of org-level tokens
4. **Migrate Credentials**: Use batch APIs to migrate existing user tokens

### Version Compatibility  

The user OAuth API is available in:
- **API Version**: 1.0+
- **SDK Version**: 1.2+
- **Minimum Node.js**: 16.x

## API Reference

For complete API documentation, see:
- [OAuth Login Endpoint](/api/auth/login) - Initiate user OAuth flow
- [OAuth Callback Endpoint](/api/auth/callback) - Handle OAuth provider callback
- [Tool Authentication API](/api/tools/auth) - Configure OAuth client credentials
- [User Credentials Management](/api/auth/credentials) - Manage user tokens