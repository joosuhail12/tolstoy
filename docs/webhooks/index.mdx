---
title: Webhooks Guide
sidebar_position: 5
---

# Webhooks Guide

Set up event-driven integrations with Tolstoy's robust webhook system. Get real-time notifications when workflows execute, steps complete, or errors occur.

## Overview

Tolstoy's webhook system provides reliable, secure delivery of workflow events to your applications. Built with enterprise-grade features including:

- **Reliable Delivery**: Automatic retries with exponential backoff (up to 5 attempts)
- **Security**: HMAC signature verification for payload authenticity
- **Comprehensive Events**: Track every aspect of workflow execution
- **Monitoring**: Prometheus metrics and detailed delivery logs
- **High Performance**: Asynchronous delivery via Inngest queues

## Webhook Events

Tolstoy sends webhooks for these event types:

### Flow Events
- `flow.started` - Workflow execution begins
- `flow.completed` - Workflow completes successfully
- `flow.failed` - Workflow fails or encounters error
- `flow.cancelled` - Workflow is manually cancelled
- `flow.retrying` - Workflow is being retried after failure

### Step Events  
- `step.started` - Individual step execution begins
- `step.completed` - Step completes successfully
- `step.failed` - Step encounters error
- `step.skipped` - Step is skipped due to conditions
- `step.retrying` - Step is being retried after failure

## Creating Webhooks

### API Request
```bash
curl -X POST https://tolstoy.getpullse.com/webhooks \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-app.com/webhook",
    "eventTypes": ["flow.completed", "flow.failed"],
    "isActive": true,
    "description": "Notify when workflows finish"
  }'
```

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `url` | string | ✅ | Your webhook endpoint URL (HTTPS required) |
| `eventTypes` | array | ✅ | Array of event types to subscribe to |
| `isActive` | boolean | ❌ | Enable/disable webhook (default: true) |
| `description` | string | ❌ | Human-readable description |

### Response
```json
{
  "id": "wh_abc123",
  "url": "https://your-app.com/webhook",
  "eventTypes": ["flow.completed", "flow.failed"],
  "isActive": true,
  "description": "Notify when workflows finish",
  "secret": "whsec_abc123...",
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-01-15T10:30:00Z"
}
```

> **Important**: Store the `secret` securely - you'll need it to verify webhook signatures.

## Webhook Payloads

All webhook payloads follow this structure:

### Base Payload
```json
{
  "id": "evt_abc123",
  "eventType": "flow.completed", 
  "timestamp": "2024-01-15T10:30:00Z",
  "orgId": "org_abc123",
  "data": {
    // Event-specific data
  }
}
```

### Flow Events Payload
```json
{
  "id": "evt_abc123",
  "eventType": "flow.completed",
  "timestamp": "2024-01-15T10:30:00Z", 
  "orgId": "org_abc123",
  "data": {
    "flowId": "flow_abc123",
    "executionId": "exec_abc123",
    "flowName": "User Onboarding Workflow",
    "status": "completed",
    "startedAt": "2024-01-15T10:29:00Z",
    "completedAt": "2024-01-15T10:30:00Z",
    "duration": 60000,
    "stepCount": 3,
    "successfulSteps": 3,
    "failedSteps": 0,
    "context": {
      "userId": "user_123",
      "email": "user@example.com"
    }
  }
}
```

### Step Events Payload
```json
{
  "id": "evt_abc123", 
  "eventType": "step.completed",
  "timestamp": "2024-01-15T10:30:00Z",
  "orgId": "org_abc123",
  "data": {
    "flowId": "flow_abc123",
    "executionId": "exec_abc123", 
    "stepKey": "send-welcome-email",
    "stepName": "Send Welcome Email",
    "actionKey": "sendgrid.send-email",
    "status": "completed",
    "startedAt": "2024-01-15T10:29:30Z",
    "completedAt": "2024-01-15T10:29:45Z", 
    "duration": 15000,
    "inputs": {
      "to": "user@example.com",
      "subject": "Welcome!"
    },
    "outputs": {
      "messageId": "msg_abc123",
      "status": "sent"
    }
  }
}
```

## Security & Verification

### HMAC Signature Verification

Every webhook includes an HMAC signature in the `x-tolstoy-signature` header:

```
x-tolstoy-signature: sha256=abc123def456...
```

#### Verification Example (Node.js)
```javascript
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload, 'utf8')
    .digest('hex');
  
  const providedSignature = signature.replace('sha256=', '');
  
  return crypto.timingSafeEqual(
    Buffer.from(expectedSignature, 'hex'),
    Buffer.from(providedSignature, 'hex')
  );
}

// Express.js middleware example
app.use('/webhook', express.raw({type: 'application/json'}));

app.post('/webhook', (req, res) => {
  const signature = req.headers['x-tolstoy-signature'];
  const payload = req.body;
  
  if (!verifyWebhookSignature(payload, signature, process.env.WEBHOOK_SECRET)) {
    return res.status(401).send('Unauthorized');
  }
  
  const event = JSON.parse(payload);
  console.log('Received event:', event.eventType);
  
  res.status(200).send('OK');
});
```

#### Verification Example (Python)
```python
import hmac
import hashlib
import json

def verify_webhook_signature(payload, signature, secret):
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        payload,
        hashlib.sha256
    ).hexdigest()
    
    provided_signature = signature.replace('sha256=', '')
    return hmac.compare_digest(expected_signature, provided_signature)

# Flask example  
from flask import Flask, request

@app.route('/webhook', methods=['POST'])
def handle_webhook():
    signature = request.headers.get('x-tolstoy-signature')
    payload = request.get_data()
    
    if not verify_webhook_signature(payload, signature, os.environ['WEBHOOK_SECRET']):
        return 'Unauthorized', 401
        
    event = json.loads(payload)
    print(f"Received event: {event['eventType']}")
    
    return 'OK', 200
```

## Webhook Management

### List Webhooks
```bash
curl https://tolstoy.getpullse.com/webhooks \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id"
```

### Filter by Event Type
```bash
curl "https://tolstoy.getpullse.com/webhooks?eventType=flow.completed" \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id"
```

### Toggle Webhook Status
```bash
curl -X PATCH https://tolstoy.getpullse.com/webhooks/wh_abc123/toggle \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id"
```

### Test Webhook Delivery
```bash
curl -X POST https://tolstoy.getpullse.com/webhooks/wh_abc123/test \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id" \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "flow.completed"
  }'
```

### Delete Webhook
```bash
curl -X DELETE https://tolstoy.getpullse.com/webhooks/wh_abc123 \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id"
```

## Delivery & Reliability

### Retry Policy
Failed webhook deliveries are automatically retried with exponential backoff:

1. **Immediate**: 0 seconds
2. **First Retry**: 15 seconds  
3. **Second Retry**: 45 seconds
4. **Third Retry**: 135 seconds
5. **Fourth Retry**: 405 seconds
6. **Final Attempt**: 1215 seconds (~20 minutes)

### Timeout Settings
- **Connection Timeout**: 10 seconds
- **Read Timeout**: 30 seconds
- **Total Timeout**: 40 seconds

### Delivery Status
Track delivery status via the API:

```bash
curl https://tolstoy.getpullse.com/webhooks/wh_abc123/deliveries \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id"
```

Response:
```json
{
  "deliveries": [
    {
      "id": "del_abc123",
      "eventId": "evt_abc123",
      "eventType": "flow.completed",
      "url": "https://your-app.com/webhook",
      "statusCode": 200,
      "success": true,
      "attempts": 1,
      "lastAttempt": "2024-01-15T10:30:00Z",
      "nextRetry": null,
      "error": null
    }
  ]
}
```

## Best Practices

### Endpoint Requirements
- **HTTPS Only**: Webhook URLs must use HTTPS
- **Fast Response**: Respond within 30 seconds
- **Idempotency**: Handle duplicate deliveries gracefully
- **Status Codes**: Return 2xx for success, 4xx/5xx for retries

### Security Recommendations
- Always verify HMAC signatures
- Use HTTPS endpoints only
- Validate event data structure
- Implement rate limiting
- Log webhook events for debugging

### Error Handling
```javascript
app.post('/webhook', async (req, res) => {
  try {
    // Verify signature first
    if (!verifySignature(req.body, req.headers['x-tolstoy-signature'])) {
      return res.status(401).send('Unauthorized');
    }
    
    const event = JSON.parse(req.body);
    
    // Process event idempotently
    await processEvent(event);
    
    res.status(200).send('OK');
  } catch (error) {
    console.error('Webhook error:', error);
    // Return 5xx for retries, 4xx to stop retries
    res.status(500).send('Internal Server Error');
  }
});
```

### Monitoring & Debugging
- Monitor webhook delivery success rates
- Set up alerts for failed deliveries
- Use webhook test endpoint for debugging
- Check delivery logs for troubleshooting

## Common Use Cases

### Slack Notifications
```javascript
// Send Slack notification when workflow fails
if (event.eventType === 'flow.failed') {
  await slack.chat.postMessage({
    channel: '#alerts',
    text: `🚨 Workflow "${event.data.flowName}" failed`,
    blocks: [
      {
        type: 'section',
        text: {
          type: 'mrkdwn',
          text: `*Workflow Failed*\n• Name: ${event.data.flowName}\n• Duration: ${event.data.duration}ms\n• Failed Steps: ${event.data.failedSteps}`
        }
      }
    ]
  });
}
```

### Database Logging
```python
# Log workflow completion to database
if event['eventType'] == 'flow.completed':
    db.execute('''
        INSERT INTO workflow_completions 
        (flow_id, execution_id, duration, step_count, completed_at)
        VALUES (?, ?, ?, ?, ?)
    ''', [
        event['data']['flowId'],
        event['data']['executionId'], 
        event['data']['duration'],
        event['data']['stepCount'],
        event['data']['completedAt']
    ])
```

### Email Notifications
```javascript
// Send email when important workflow completes
if (event.eventType === 'flow.completed' && event.data.flowName.includes('Daily Report')) {
  await sendEmail({
    to: 'team@company.com',
    subject: 'Daily Report Generated',
    html: `
      <h2>Daily Report Completed</h2>
      <p>Duration: ${event.data.duration}ms</p>
      <p>Steps: ${event.data.successfulSteps}/${event.data.stepCount}</p>
    `
  });
}
```

## Troubleshooting

### Common Issues

**Webhook Not Receiving Events**
- Check webhook URL is accessible via HTTPS
- Verify event types are correctly configured
- Ensure webhook is marked as active

**Signature Verification Failing**
- Use raw request body for signature calculation
- Ensure secret matches the one from webhook creation
- Check HMAC implementation matches examples above

**High Retry Rates**
- Optimize webhook endpoint response time
- Return appropriate HTTP status codes
- Implement proper error handling

### Debug Webhook
Use the test endpoint to debug your webhook implementation:

```bash
curl -X POST https://tolstoy.getpullse.com/webhooks/wh_abc123/test \
  -H "x-org-id: your-org-id" \
  -H "x-user-id: your-user-id" \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "flow.completed",
    "testData": {
      "flowId": "flow_test",
      "executionId": "exec_test"
    }
  }'
```

## Next Steps

- **[Flow Definition Guide](/flow-definition)** - Learn how to create workflows that trigger webhooks
- **[API Reference](/api)** - Complete webhook API documentation  
- **[Execution Monitoring](/execution)** - Track workflow performance and results
- **[Security Guide](/security)** - Best practices for secure integrations