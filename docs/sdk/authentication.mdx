---
title: Authentication
sidebar_position: 3
---

# Authentication

The Tolstoy SDK supports flexible authentication for multi-tenant applications.

## Multi-Tenant Headers

The SDK automatically adds these headers to all requests:

```typescript
const client = new TolstoyClient(
  'https://tolstoy.getpullse.com',
  'org_abc123',    // x-org-id header
  'user_def456',   // x-user-id header
  'bearer_token'   // Authorization header (optional)
);
```

### Required Headers

- **`x-org-id`**: Your organization identifier (required)
- **`x-user-id`**: User context for the request (required)

### Optional Authentication

- **`Authorization`**: Bearer token for additional security (optional)

## Authentication Patterns

### Basic Multi-Tenant Setup

```typescript
import { TolstoyClient } from '@joosuhail/tolstoy-sdk';

const client = new TolstoyClient(
  process.env.TOLSTOY_API_URL,
  process.env.TOLSTOY_ORG_ID,
  getCurrentUserId(), // Your user context logic
);
```

### With Bearer Token

```typescript
const client = new TolstoyClient(
  'https://tolstoy.getpullse.com',
  'org_123',
  'user_456',
  process.env.TOLSTOY_API_TOKEN
);
```

### Environment Variables

Set up environment variables for secure configuration:

```bash
# .env
TOLSTOY_API_URL=https://tolstoy.getpullse.com
TOLSTOY_ORG_ID=org_abc123
TOLSTOY_API_TOKEN=your_bearer_token_here
```

```typescript
const client = new TolstoyClient(
  process.env.TOLSTOY_API_URL!,
  process.env.TOLSTOY_ORG_ID!,
  getCurrentUserId(),
  process.env.TOLSTOY_API_TOKEN
);
```

## Dynamic Authentication

### Per-User Clients

```typescript
class TolstoyService {
  private baseUrl = process.env.TOLSTOY_API_URL!;
  private orgId = process.env.TOLSTOY_ORG_ID!;

  getClientForUser(userId: string, token?: string): TolstoyClient {
    return new TolstoyClient(
      this.baseUrl,
      this.orgId,
      userId,
      token
    );
  }
}

// Usage
const service = new TolstoyService();
const userClient = service.getClientForUser('user_123');
```

### JWT Token Integration

```typescript
import jwt from 'jsonwebtoken';

function createAuthenticatedClient(jwtToken: string) {
  const decoded = jwt.verify(jwtToken, process.env.JWT_SECRET!) as any;
  
  return new TolstoyClient(
    process.env.TOLSTOY_API_URL!,
    decoded.orgId,
    decoded.userId,
    jwtToken // Pass JWT as bearer token
  );
}
```

## Header Customization

For advanced use cases, you can access the raw API and customize headers:

```typescript
const client = new TolstoyClient(baseUrl, orgId, userId);

// Access raw API for custom headers
const customRequest = await client.raw.flows.flowsControllerFindAll({
  headers: {
    'Custom-Header': 'custom-value',
    'X-Request-ID': generateRequestId()
  }
});
```

## Security Best Practices

### 1. Environment Variables
Never hardcode credentials in your source code:

```typescript
// ✅ Good
const client = new TolstoyClient(
  process.env.TOLSTOY_API_URL!,
  process.env.TOLSTOY_ORG_ID!,
  userId,
  process.env.TOLSTOY_API_TOKEN
);

// ❌ Bad
const client = new TolstoyClient(
  'https://tolstoy.getpullse.com',
  'org_hardcoded_123', // Never hardcode
  userId,
  'token_hardcoded'    // Never hardcode
);
```

### 2. Token Rotation
Implement token rotation for long-lived applications:

```typescript
class AuthenticatedTolstoyClient {
  private client: TolstoyClient;
  private tokenExpiryTime: number;

  constructor(baseUrl: string, orgId: string, userId: string) {
    this.updateClient(baseUrl, orgId, userId);
  }

  private async updateClient(baseUrl: string, orgId: string, userId: string) {
    const token = await this.refreshToken();
    this.client = new TolstoyClient(baseUrl, orgId, userId, token);
    this.tokenExpiryTime = Date.now() + (55 * 60 * 1000); // 55 minutes
  }

  async runFlow(flowId: string, inputs: any) {
    if (Date.now() > this.tokenExpiryTime) {
      await this.updateClient(/* params */);
    }
    return this.client.runFlow(flowId, inputs);
  }

  private async refreshToken(): Promise<string> {
    // Your token refresh logic
    return 'new_token';
  }
}
```

### 3. Request Validation
Validate requests before sending:

```typescript
function validateOrgAccess(orgId: string, userId: string): boolean {
  // Your validation logic
  return userHasAccessToOrg(userId, orgId);
}

function createValidatedClient(orgId: string, userId: string) {
  if (!validateOrgAccess(orgId, userId)) {
    throw new Error('User does not have access to this organization');
  }

  return new TolstoyClient(
    process.env.TOLSTOY_API_URL!,
    orgId,
    userId
  );
}
```

## Troubleshooting Authentication

### Common Issues

1. **Missing Organization ID**
   ```
   Error: x-org-id header is required
   ```
   Solution: Ensure you're passing the organization ID as the second parameter.

2. **Invalid User Context**
   ```
   Error: x-user-id header is required  
   ```
   Solution: Ensure you're passing a valid user ID as the third parameter.

3. **Token Expired**
   ```
   Error: 401 Unauthorized
   ```
   Solution: Refresh your bearer token and create a new client instance.

### Debug Authentication

```typescript
const client = new TolstoyClient(baseUrl, orgId, userId, token);

// Check what headers are being sent
console.log('Client configured with:', {
  baseUrl,
  orgId: orgId ? '***' : 'missing',
  userId: userId ? '***' : 'missing',
  hasToken: !!token
});
```

## Next Steps

- [Core Features](/sdk/core-features) - Learn about workflows, tools, and webhooks
- [Examples](/sdk/examples) - See authentication in real-world scenarios
- [API Reference](/sdk/api-reference) - Complete method documentation