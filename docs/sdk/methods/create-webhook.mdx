---
title: createWebhook()
sidebar_position: 7
---

# createWebhook()

Create a new webhook to receive real-time notifications about events in your Tolstoy workflows.

## Signature

```typescript
createWebhook(webhookData: CreateWebhookDto): Promise<Webhook>
```

## Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `webhookData` | `CreateWebhookDto` | Webhook configuration |

### CreateWebhookDto Interface

```typescript
interface CreateWebhookDto {
  name: string;
  url: string;
  events: string[];
  active?: boolean;
  secret?: string;
  headers?: Record<string, string>;
  timeout?: number;
  retries?: number;
  metadata?: Record<string, any>;
  verifySSL?: boolean;
}
```

## Returns

Returns a `Promise<Webhook>`:

```typescript
interface Webhook {
  data: {
    id: string;
    name: string;
    url: string;
    events: string[];
    active: boolean;
    secret?: string;
    createdAt: string;
    updatedAt: string;
    lastDelivery?: string;
    deliveryCount: number;
    failureCount: number;
  };
}
```

## Usage Examples

### Basic Workflow Notifications
```typescript
const webhook = await client.createWebhook({
  name: 'Workflow Monitor',
  url: 'https://your-app.com/webhooks/tolstoy',
  events: ['flow.completed', 'flow.failed'],
  active: true
});

console.log(`Webhook created: ${webhook.data.id}`);
console.log(`Listening for: ${webhook.data.events.join(', ')}`);
```

### Comprehensive Event Monitoring
```typescript
const allEventsWebhook = await client.createWebhook({
  name: 'Complete Event Monitor',
  url: 'https://your-app.com/webhooks/all-events',
  events: [
    'flow.started',
    'flow.completed', 
    'flow.failed',
    'flow.cancelled',
    'tool.connected',
    'tool.failed',
    'user.created'
  ],
  active: true,
  timeout: 15000,
  retries: 3
});
```

### Secure Webhook with Secret
```typescript
const secureWebhook = await client.createWebhook({
  name: 'Secure Production Webhook',
  url: 'https://api.yourcompany.com/webhooks/tolstoy',
  events: ['flow.completed', 'flow.failed'],
  active: true,
  secret: process.env.WEBHOOK_SECRET, // Used for signature verification
  verifySSL: true,
  headers: {
    'X-Source': 'Tolstoy',
    'X-Environment': 'production'
  }
});
```

### Development Webhook with ngrok
```typescript
const devWebhook = await client.createWebhook({
  name: 'Development Webhook',
  url: 'https://abc123.ngrok.io/webhooks/tolstoy',
  events: ['flow.started', 'flow.completed', 'flow.failed'],
  active: true,
  metadata: {
    environment: 'development',
    developer: 'john.doe@company.com'
  }
});
```

## Available Event Types

### Workflow Events
```typescript
const workflowWebhook = await client.createWebhook({
  name: 'Workflow Events',
  url: 'https://your-app.com/webhooks/workflows',
  events: [
    'flow.started',      // Workflow execution began
    'flow.completed',    // Workflow finished successfully  
    'flow.failed',       // Workflow failed with error
    'flow.cancelled',    // Workflow was cancelled
    'flow.step_completed', // Individual step completed
    'flow.step_failed'   // Individual step failed
  ],
  active: true
});
```

### Tool Events
```typescript
const toolWebhook = await client.createWebhook({
  name: 'Tool Integration Monitor',
  url: 'https://your-app.com/webhooks/tools',
  events: [
    'tool.connected',    // Tool integration established
    'tool.failed',       // Tool integration failed
    'tool.updated'       // Tool configuration changed
  ],
  active: true
});
```

### Organization Events
```typescript
const orgWebhook = await client.createWebhook({
  name: 'Organization Activity',
  url: 'https://your-app.com/webhooks/organization',
  events: [
    'org.updated',       // Organization settings changed
    'org.user_added',    // User added to organization
    'org.user_removed'   // User removed from organization
  ],
  active: true
});
```

### User Events
```typescript
const userWebhook = await client.createWebhook({
  name: 'User Management',
  url: 'https://your-app.com/webhooks/users',
  events: [
    'user.created',      // New user account created
    'user.updated',      // User profile updated
    'user.deleted'       // User account deleted
  ],
  active: true
});
```

## Common Use Cases

### CI/CD Integration
```typescript
const cicdWebhook = await client.createWebhook({
  name: 'CI/CD Pipeline Trigger',
  url: 'https://ci.company.com/webhooks/tolstoy',
  events: ['flow.completed'],
  active: true,
  headers: {
    'Authorization': 'Bearer ' + process.env.CI_API_TOKEN,
    'X-Pipeline': 'deployment'
  },
  metadata: {
    purpose: 'trigger_deployment',
    pipeline: 'production'
  }
});
```

### Slack Notifications
```typescript
const slackWebhook = await client.createWebhook({
  name: 'Slack Notifications',
  url: process.env.SLACK_WEBHOOK_URL,
  events: ['flow.failed', 'tool.failed'],
  active: true,
  timeout: 10000,
  metadata: {
    channel: '#alerts',
    purpose: 'error_notifications'
  }
});
```

### Analytics Tracking
```typescript
const analyticsWebhook = await client.createWebhook({
  name: 'Analytics Tracker',
  url: 'https://analytics.company.com/events/tolstoy',
  events: [
    'flow.started',
    'flow.completed',
    'user.created',
    'org.user_added'
  ],
  active: true,
  headers: {
    'X-Analytics-Key': process.env.ANALYTICS_API_KEY,
    'Content-Type': 'application/json'
  }
});
```

### Customer Success Monitoring
```typescript
const customerSuccessWebhook = await client.createWebhook({
  name: 'Customer Success Events',
  url: 'https://cs-platform.company.com/webhooks/tolstoy',
  events: [
    'user.created',
    'flow.completed',
    'org.user_added'
  ],
  active: true,
  metadata: {
    team: 'customer_success',
    priority: 'high'
  }
});
```

## Error Handling

```typescript
import { AxiosError } from 'axios';

try {
  const webhook = await client.createWebhook({
    name: 'My Webhook',
    url: 'https://my-app.com/webhooks/tolstoy',
    events: ['flow.completed'],
    active: true
  });
  
  console.log(`Webhook created: ${webhook.data.id}`);
} catch (error) {
  const apiError = error as AxiosError;
  
  if (apiError.response) {
    const { status, data } = apiError.response;
    
    switch (data.error.code) {
      case 'VALIDATION_ERROR':
        console.error('Invalid webhook configuration:', data.error.details);
        if (data.error.details.field === 'url') {
          console.error('Make sure the URL is valid and accessible');
        }
        break;
      case 'CONFLICT':
        console.error('Webhook with this URL already exists');
        break;
      case 'RATE_LIMITED':
        console.error('Too many webhook creation requests');
        break;
      default:
        console.error(`API Error ${status}:`, data.error.message);
    }
  } else {
    console.error('Network error:', error.message);
  }
}
```

## Webhook Security

### Signature Verification
```typescript
const secureWebhook = await client.createWebhook({
  name: 'Secure Webhook',
  url: 'https://your-app.com/webhooks/secure',
  events: ['flow.completed'],
  secret: crypto.randomBytes(32).toString('hex'), // Strong secret
  active: true
});

// In your webhook handler:
function verifySignature(payload: string, signature: string, secret: string): boolean {
  const crypto = require('crypto');
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

### HTTPS Enforcement
```typescript
const httpsWebhook = await client.createWebhook({
  name: 'HTTPS Only Webhook',
  url: 'https://secure.company.com/webhooks',
  events: ['flow.started'],
  verifySSL: true, // Enforce SSL certificate validation
  active: true
});
```

## Advanced Usage

### Webhook Factory
```typescript
class WebhookFactory {
  static async createFlowMonitor(
    url: string,
    options: { name?: string; includeSteps?: boolean } = {}
  ): Promise<Webhook> {
    const events = ['flow.started', 'flow.completed', 'flow.failed'];
    if (options.includeSteps) {
      events.push('flow.step_completed', 'flow.step_failed');
    }
    
    return client.createWebhook({
      name: options.name || 'Flow Monitor',
      url,
      events,
      active: true,
      metadata: {
        type: 'flow_monitor',
        includeSteps: options.includeSteps || false
      }
    });
  }
  
  static async createErrorAlerting(
    url: string,
    alertChannel: string
  ): Promise<Webhook> {
    return client.createWebhook({
      name: 'Error Alerts',
      url,
      events: ['flow.failed', 'tool.failed'],
      active: true,
      metadata: {
        type: 'error_alerts',
        channel: alertChannel,
        severity: 'high'
      }
    });
  }
  
  static async createAnalytics(
    url: string,
    apiKey: string
  ): Promise<Webhook> {
    return client.createWebhook({
      name: 'Analytics Webhook',
      url,
      events: [
        'flow.started',
        'flow.completed', 
        'user.created',
        'org.user_added'
      ],
      active: true,
      headers: {
        'X-API-Key': apiKey,
        'Content-Type': 'application/json'
      },
      metadata: {
        type: 'analytics',
        purpose: 'usage_tracking'
      }
    });
  }
}

// Usage
const flowMonitor = await WebhookFactory.createFlowMonitor(
  'https://your-app.com/webhooks/flows',
  { name: 'Production Flow Monitor', includeSteps: true }
);

const errorAlerting = await WebhookFactory.createErrorAlerting(
  process.env.SLACK_WEBHOOK_URL!,
  '#alerts'
);
```

### Webhook Testing
```typescript
async function testWebhookEndpoint(url: string): Promise<boolean> {
  try {
    const testPayload = {
      event: 'test.webhook',
      timestamp: new Date().toISOString(),
      data: { test: true }
    };
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Tolstoy-Event': 'test.webhook'
      },
      body: JSON.stringify(testPayload),
      signal: AbortSignal.timeout(10000)
    });
    
    return response.ok;
  } catch (error) {
    console.error(`Webhook endpoint test failed: ${error.message}`);
    return false;
  }
}

const webhookUrl = 'https://your-app.com/webhooks/tolstoy';
const isReachable = await testWebhookEndpoint(webhookUrl);

if (isReachable) {
  const webhook = await client.createWebhook({
    name: 'Tested Webhook',
    url: webhookUrl,
    events: ['flow.completed'],
    active: true
  });
} else {
  console.error('Webhook endpoint is not reachable');
}
```

### Multi-Environment Webhooks
```typescript
const environment = process.env.NODE_ENV || 'development';

const webhookConfigs = {
  development: {
    name: 'Dev Webhook',
    url: 'https://localhost:3000/webhooks/tolstoy',
    verifySSL: false
  },
  staging: {
    name: 'Staging Webhook',
    url: 'https://staging-api.company.com/webhooks/tolstoy',
    verifySSL: true
  },
  production: {
    name: 'Production Webhook',
    url: 'https://api.company.com/webhooks/tolstoy',
    verifySSL: true,
    secret: process.env.WEBHOOK_SECRET
  }
};

const config = webhookConfigs[environment];
const webhook = await client.createWebhook({
  ...config,
  events: ['flow.completed', 'flow.failed'],
  active: true,
  metadata: {
    environment,
    created_by: 'deploy_script'
  }
});
```

### Webhook Management System
```typescript
class WebhookManager {
  async createOrUpdate(
    name: string, 
    config: Omit<CreateWebhookDto, 'name'>
  ): Promise<Webhook> {
    // Check if webhook already exists
    const webhooks = await client.listWebhooks();
    const existing = webhooks.data.find(w => w.name === name);
    
    if (existing) {
      console.log(`Updating existing webhook: ${name}`);
      return client.raw.webhooks.webhooksControllerUpdate(existing.id, {
        ...config,
        name
      });
    } else {
      console.log(`Creating new webhook: ${name}`);
      return client.createWebhook({ ...config, name });
    }
  }
  
  async setupStandardWebhooks(baseUrl: string): Promise<Webhook[]> {
    const webhooks: Promise<Webhook>[] = [];
    
    // Error monitoring
    webhooks.push(this.createOrUpdate('Error Monitor', {
      url: `${baseUrl}/webhooks/errors`,
      events: ['flow.failed', 'tool.failed'],
      active: true
    }));
    
    // Success tracking
    webhooks.push(this.createOrUpdate('Success Tracker', {
      url: `${baseUrl}/webhooks/success`,
      events: ['flow.completed'],
      active: true
    }));
    
    // User activity
    webhooks.push(this.createOrUpdate('User Activity', {
      url: `${baseUrl}/webhooks/users`,
      events: ['user.created', 'user.updated'],
      active: true
    }));
    
    return Promise.all(webhooks);
  }
}

const manager = new WebhookManager();
const standardWebhooks = await manager.setupStandardWebhooks(
  'https://your-app.com'
);

console.log(`Created/updated ${standardWebhooks.length} standard webhooks`);
```

## Integration Patterns

### Event Router
```typescript
interface WebhookRoute {
  events: string[];
  handler: string;
  conditions?: Record<string, any>;
}

class WebhookRouter {
  private routes: WebhookRoute[] = [
    {
      events: ['flow.failed'],
      handler: 'error-handler',
      conditions: { severity: 'high' }
    },
    {
      events: ['flow.completed'],
      handler: 'success-handler'
    },
    {
      events: ['user.created', 'org.user_added'],
      handler: 'user-handler'
    }
  ];
  
  async setupRoutes(baseUrl: string): Promise<Webhook[]> {
    const webhooks: Promise<Webhook>[] = [];
    
    this.routes.forEach((route, index) => {
      webhooks.push(client.createWebhook({
        name: `Route ${index + 1}: ${route.handler}`,
        url: `${baseUrl}/webhooks/${route.handler}`,
        events: route.events,
        active: true,
        metadata: {
          route_id: index,
          handler: route.handler,
          conditions: route.conditions
        }
      }));
    });
    
    return Promise.all(webhooks);
  }
}

const router = new WebhookRouter();
const routes = await router.setupRoutes('https://your-app.com');
```

## Best Practices

### Idempotency
```typescript
// In your webhook handler
app.post('/webhooks/tolstoy', async (req, res) => {
  const eventId = req.headers['x-tolstoy-event-id'];
  
  // Check if we've already processed this event
  if (await isEventProcessed(eventId)) {
    return res.status(200).send('Already processed');
  }
  
  try {
    await processEvent(req.body);
    await markEventProcessed(eventId);
    res.status(200).send('OK');
  } catch (error) {
    console.error('Webhook processing failed:', error);
    res.status(500).send('Processing failed');
  }
});
```

### Error Recovery
```typescript
async function createWebhookWithRetry(
  webhookData: CreateWebhookDto,
  maxRetries = 3
): Promise<Webhook> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await client.createWebhook(webhookData);
    } catch (error) {
      if (attempt === maxRetries) throw error;
      
      console.warn(`Attempt ${attempt} failed, retrying...`);
      await new Promise(resolve => setTimeout(resolve, attempt * 1000));
    }
  }
  throw new Error('Should never reach here');
}
```

### Webhook Validation
```typescript
function validateWebhookConfig(config: CreateWebhookDto): string[] {
  const errors: string[] = [];
  
  if (!config.name?.trim()) {
    errors.push('Webhook name is required');
  }
  
  if (!config.url?.trim()) {
    errors.push('Webhook URL is required');
  } else {
    try {
      const url = new URL(config.url);
      if (url.protocol !== 'https:') {
        errors.push('Webhook URL must use HTTPS in production');
      }
    } catch {
      errors.push('Invalid webhook URL format');
    }
  }
  
  if (!config.events?.length) {
    errors.push('At least one event type is required');
  }
  
  return errors;
}
```

## Related Methods

- [listWebhooks()](/sdk/methods/list-webhooks) - View all webhooks
- [runFlow()](/sdk/methods/run-flow) - Trigger events that webhooks receive
- [TolstoyClient](/sdk/methods/tolstoy-client) - Client setup

## See Also

- [Create Webhook API](/api/webhooks/post-webhooks) - Direct API documentation
- [Webhook Events Guide](/docs/webhooks) - Complete event reference
- [SDK Examples](/sdk/examples) - Real-world webhook patterns