---
title: Flow Definition Guide
sidebar_position: 2
---


# Flow Definition Guide

Learn how to define and structure workflows in Tolstoy.

> **Info:** Flows are immutable once publishedâ€”use the `version` field to evolve.

## Flow Schema

Every flow follows a standardized schema:

```json
{
  "id": "string",
  "version": 1,
  "steps": [
    {
      "key": "create-issue",
      "action": "jira.create-issue",
      "inputs": { /* ... */ }
    }
  ]
}
```

## Steps

Each step in a flow has these key properties:

**key**: Unique within the flow

**action**: Format is `<orgId>.<toolKey>.<actionKey>`

**inputs**: Must match the Action's inputSchema

**executeIf** (optional): JSONLogic condition to skip

## Example Flow

Here's a complete example that demonstrates key concepts:

```yaml
version: 1
name: "GitHub Issue Processing"
steps:
  - key: "validate-issue"
    action: "github.validate"
    inputs:
      issue_id: "{{context.issueId}}"
      required_fields: ["title", "body"]
    
  - key: "create-jira-ticket"
    action: "jira.create-issue"
    inputs:
      project: "PROJ"
      summary: "{{steps.validate-issue.output.title}}"
      description: "{{steps.validate-issue.output.body}}"
    executeIf:
      operator: "equals"
      field: "steps.validate-issue.output.valid"
      value: true
    
  - key: "notify-team"
    action: "slack.message"
    inputs:
      channel: "#dev-team"
      text: "New issue processed: {{steps.create-jira-ticket.output.key}}"
```

## Conditional Execution

Use `executeIf` to conditionally run steps:

```json
"executeIf": {
  "operator": "and",
  "conditions": [
    {
      "operator": "exists",
      "field": "context.userId"
    },
    {
      "operator": "equals",
      "field": "context.environment",
      "value": "production"
    }
  ]
}
```

### Available Operators

- `equals`, `not_equals`
- `greater_than`, `less_than`
- `exists`, `not_exists` 
- `contains`, `not_contains`
- `and`, `or`, `not`

## Data Flow

Access data from previous steps using the `steps` context:

```yaml
inputs:
  user_id: "{{steps.fetch-user.output.id}}"
  user_name: "{{steps.fetch-user.output.name}}"
```

Access execution context:

```yaml
inputs:
  org_id: "{{context.orgId}}"
  execution_id: "{{context.executionId}}"
  current_time: "{{now()}}"
```

## Error Handling

Configure how your flow responds to errors:

```yaml
errorHandling:
  strategy: "retry"      # retry | fail_fast | continue
  maxRetries: 3
  backoff: "exponential" # linear | exponential | fixed
```

## Step Dependencies

Control execution order with `dependsOn`:

```yaml
steps:
  - key: "setup"
    action: "database.migrate"
    
  - key: "process"
    action: "data.transform"
    dependsOn: ["setup"]
    
  - key: "cleanup"
    action: "temp.cleanup"
    dependsOn: ["setup", "process"]
```

## Variables

Define reusable variables:

```yaml
variables:
  api_endpoint: "https://api.service.com"
  timeout_ms: 5000
  environment: "{{context.env}}"

steps:
  - key: "api-call"
    action: "http.get"
    inputs:
      url: "{{variables.api_endpoint}}/users"
      timeout: "{{variables.timeout_ms}}"
```

## Best Practices

> **Tip:** Design for Idempotency - Make sure your flows can be safely re-run without side effects.

- Keep flows focused on a single business process
- Use descriptive names for steps and variables
- Include error handling for external API calls
- Add conditional logic to handle different scenarios
- Document your flows with clear descriptions

## Advanced Patterns

### Parallel Execution

Steps without dependencies run in parallel:

```yaml
steps:
  # These run in parallel
  - key: "fetch-user"
    action: "api.get"
    inputs:
      url: "/users/123"
      
  - key: "fetch-account"
    action: "api.get" 
    inputs:
      url: "/accounts/456"
      
  # This waits for both
  - key: "merge-data"
    action: "data.merge"
    dependsOn: ["fetch-user", "fetch-account"]
```

### Loop Patterns

Process arrays of data:

```yaml
variables:
  user_ids: ["user1", "user2", "user3"]

steps:
  - key: "process-users"
    action: "control.for_each"
    inputs:
      items: "{{variables.user_ids}}"
      steps:
        - action: "user.notify"
          inputs:
            user_id: "{{item}}"
```

## Next Steps

- Learn about [Actions](/action-reference) to understand available operations
- Explore [integrations](/integrations) for connecting external services
- Check out [example flows](https://github.com/tolstoy/examples) for real-world patterns